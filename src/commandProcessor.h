#ifndef __COMMANDPROCESSOR_H_INCLUDED__
#define __COMMANDPROCESSOR_H_INCLUDED__

#include <ESP8266WiFi.h>
#include "protocol.h"
#include "hmac.h"

//TODO: this is only a dev key, move it to SPIFFS 
const Block KEY = {
  0x3f, 0x42, 0x27, 0x56, 0xa5, 0x27, 0xbe, 0x91, 
  0x3c, 0x56, 0x55, 0x39, 0x0f, 0x23, 0x11, 0x90, 
  0xb8, 0x81, 0x65, 0x0e, 0x76, 0x5e, 0x48, 0xb7, 
  0x99, 0x92, 0xe0, 0xbc, 0x32, 0xff, 0xbe, 0x12, 
  0x19, 0x4a, 0x8b, 0x6f, 0xf0, 0x78, 0xdf, 0xcb, 
  0xf7, 0xde, 0x36, 0x33, 0xcf, 0xa0, 0x50, 0xb4, 
  0xa8, 0xb4, 0x8d, 0xc0, 0x97, 0x62, 0x01, 0x38, 
  0x91, 0x94, 0xec, 0x11, 0xc5, 0x65, 0x4f, 0xd9
};

enum CommandError {
  SUCCESS,
  READ_TIMEOUT,
  AUTH_FAILURE
};
//
//  PAIR,
//  READ_SENSOR,
//  OPEN,
//  CLOSE
//};

struct Command {
  Message message;
  Digest digest;
};

class CommandProcessor
{
  private:
    WiFiClient& client;
    unsigned long millisSince(unsigned long);
  public:
    CommandProcessor(WiFiClient& _client) : client(_client) { }
    CommandError readCommand(Command&, HardwareSerial&);
};

#endif
